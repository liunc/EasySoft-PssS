@using System.Collections.Generic;
@using EasySoft.PssS.Web.Resources;

@model EasySoft.PssS.Web.Models.Purchase.PurchaseAddModel

@{
    ViewBag.Title = Model.Title;
}

<div class="cart-panel">
    <form id="formAddPurchase" class="am-form am-form-horizontal">
        <div class="am-form-group am-form-group-sm">
            <label for="txtDate" class="am-u-sm-3 am-form-label">@WebResource.Purchase_Add_Date</label>
            <div class="am-u-sm-9">
                <input id="txtDate" type="text" class="am-form-field" placeholder="@WebResource.Purchase_Add_DateTip" data-am-datepicker="{theme: 'primary'}" readonly required>
            </div>
        </div>
        <div class="am-form-group am-form-group-sm">
            <label for="ddlItem" class="am-u-sm-3 am-form-label">@WebResource.Purchase_Add_Item</label>
            <div class="am-u-sm-9">
                <select id="ddlItem" class="am-form-field" data-am-selected="{btnWidth: '100%', btnSize: 'sm'}" required>
                    <option value="">@WebResource.Purchase_Add_ItemTip</option>
                    @foreach (var item in Model.PurchaseItems)
                    {
                        <option value="@item.Code">@item.Name</option>
                    }
                </select>
            </div>
        </div>
        <div class="am-form-group am-form-group-sm">
            <label for="txtQuantity" class="am-u-sm-3 am-form-label">@WebResource.Purchase_Add_Quantity</label>
            <div class="am-u-sm-9">
                <input id="txtQuantity" type="number" min="0.01" max="99999999.99" class="am-form-field" placeholder="@WebResource.Purchase_Add_QuantityTip1">
            </div>
        </div>
        <div class="am-form-group am-form-group-sm">
            <label for="txtSupplier" class="am-u-sm-3 am-form-label">@WebResource.Purchase_Add_Supplier</label>
            <div class="am-u-sm-9">
                <input id="txtSupplier" type="text" class="am-form-field" placeholder="@WebResource.Purchase_Add_SupplierTip">
            </div>
        </div>
        @foreach (var cost in Model.Costs)
        {
            <div class="am-form-group am-form-group-sm">
                <label for="@cost.ItemCode" class="am-u-sm-3 am-form-label">@cost.ItemName</label>
                <div class="am-u-sm-9">
                    <input type="number" min="0" max="99999999.99" id="@cost.ItemCode" name="costMoney" class="am-form-field" placeholder="@WebResource.Purchase_Add_MoneyTip">
                </div>
            </div>
        }
        <div class="am-form-group am-form-group-sm">
            <label for="txtRemark" class="am-u-sm-3 am-form-label">@WebResource.Purchase_Add_Remark</label>
            <div class="am-u-sm-9">
                <textarea class="am-form-field" rows="4" id="txtRemark" maxlength="120" placeholder="@WebResource.Purchase_Add_RemarkTip"></textarea>
            </div>
        </div>
        <div class="am-form-group">
            <div class="am-u-sm-9 am-u-sm-offset-3">
                <button id="btnSubmit" type="submit" class="am-btn am-btn-success">@WebResource.Button_Submit</button>
            </div>
        </div>
    </form>
</div>
@foreach (var item in Model.PurchaseItems)
{
    <input type="hidden" id="@item.Code" value="@item.InputUnit" />
}
<div class="am-modal am-modal-alert" tabindex="-1" id="alertError">
    <div class="am-modal-dialog">
        <div class="am-modal-bd" id="errorMessage">

        </div>
        <div class="am-modal-footer">
            <span class="am-modal-btn">@WebResource.Button_Ok</span>
        </div>
    </div>
</div>
@section scripts {
    <script type="text/javascript">

        $(function () {
            $('#ddlItem').change(function () {
                var item = $('#ddlItem').val();
                var placeholder = '@WebResource.Purchase_Add_QuantityTip1';
                if (item.length > 0) {
                    var unit = $('#' + item).val();
                    placeholder = '@WebResource.Purchase_Add_QuantityTip2' + unit;
                }
                $('#txtQuantity').attr('placeholder', placeholder);
            });
            $('#formAddPurchase').validator({
                onValid: function (validity) {
                    $(validity.field).closest('.am-u-sm-9').find('.am-alert').hide();
                },
                onInValid: function (validity) {
                    var $field = $(validity.field);
                    var $group = $field.closest('.am-u-sm-9');
                    var $alert = $group.find('.am-alert');
                    // 使用自定义的提示信息 或 插件内置的提示信息
                    var msg = $field.data('validationMessage') || this.getValidationMessage(validity);
                    if (!$alert.length) {
                        $alert = $('<div class="am-alert am-alert-danger"></div>').hide().
                          appendTo($group);
                    }
                    $alert.html(msg).show();
                },
                submit: function () {
                    if (this.isFormValid()) {
                        $('#btnSubmit').attr({ 'disabled': 'disabled' });
                        var model = {};
                        model.Date = $.trim($('#txtDate').val());
                        model.Category = '@Model.Category';
                        model.Item = $.trim($('#ddlItem').val());
                        model.Quantity = parseFloat($('#txtQuantity').val());
                        model.Unit = $.trim($('#' + model.Item).val());
                        model.Supplier = $.trim($('#txtSupplier').val());
                        model.Remark = $.trim($('#txtRemark').val());
                        model.Costs = [];
                        $('input[name="costMoney"]').each(function () {
                            var cost = {};
                            cost.ItemCode = $(this).attr("id");
                            cost.Money = parseFloat($(this).val());
                            model.Costs.push(cost);
                        });
                        $.ajax({
                            type: "post",
                            url: "/Purchase/IntoDepot",
                            data: { model: model },
                            success: function (result) {
                                if (result.Result) {
                                    window.location.href = result.Data;
                                }
                                else {
                                    showError(result.Message);
                                }
                                return false;
                            },
                            error: function () {
                                showError('System Error');
                            },
                            complete: function () {
                                $('#btnSubmit').removeAttr('disabled');
                            }
                        });
                    }
                    return false;
                }
            });
        });
        function showError(errorMessage) {
            $('#errorMessage').html(errorMessage);
            $('#alertError').modal();
        }
    </script>
}

